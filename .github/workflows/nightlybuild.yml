name: Nightly Build


on:
  schedule:
  - cron: "20 23 * * *"
  repository_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  buildandunittests:
    name: "Nightly Build - Main"
    env:
        ASPNETCORE_ENVIRONMENT: "Production"

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1

    - name: Install NET 9
      uses: actions/setup-dotnet@v4.0.1
      with:
        dotnet-version: '9.0.x'

    - name: Restore Nuget Packages
      run: dotnet restore Shared.sln --source ${{ secrets.PUBLICFEEDURL }} --source ${{ secrets.PRIVATEFEED_URL }}

    - name: Build Code
      run: dotnet build Shared.sln --configuration Release

    - name: Run Main Unit Tests
      run: |
        echo "ASPNETCORE_ENVIRONMENT are > ${ASPNETCORE_ENVIRONMENT}"
        dotnet test "Shared.Tests\Shared.Tests.csproj"
        dotnet test "Shared.EventStore.Tests\Shared.EventStore.Tests.csproj"

  buildlinux:
    name: "Nightly Build - Linux"
    env:
        ASPNETCORE_ENVIRONMENT: "Production"

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1

    - name: Install NET 9
      uses: actions/setup-dotnet@v4.0.1
      with:
        dotnet-version: '9.0.x'

    - name: Restore Nuget Packages
      run: dotnet restore Shared.sln --source ${{ secrets.PUBLICFEEDURL }} --source ${{ secrets.PRIVATEFEED_URL }}

    - name: Build Code
      run: dotnet build Shared.sln --configuration Release

    - name: Trust root certificate
      run: |
        sudo cp ./Shared.EventStoreContext.Tests/certs/ca/ca.crt /usr/local/share/ca-certificates/ca.crt
        sudo update-ca-certificates

    - name: Run Event Store Tests
      run: |
        echo "ASPNETCORE_ENVIRONMENT are > ${ASPNETCORE_ENVIRONMENT}"        
        dotnet test "Shared.EventStoreContext.Tests\Shared.EventStoreContext.Tests.csproj"

    - name: Run Integration Tests
      run: |
        echo "ASPNETCORE_ENVIRONMENT are > ${ASPNETCORE_ENVIRONMENT}"
        dotnet test "Shared.IntegrationTesting.Tests\Shared.IntegrationTesting.Tests.csproj"

    - uses: actions/upload-artifact@v4.4.3
      if: ${{ failure() }}
      with:
        name: tracelogslinux
        path: /home/txnproc/trace/   
  
  codecoverage:
    name: "Nightly Build - Code Coverage"
    env:
        ASPNETCORE_ENVIRONMENT: "Production"

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2.3.4

    - name: Install NET 9
      uses: actions/setup-dotnet@v4.0.1
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore Nuget Packages
      run: dotnet restore Shared.sln --source ${{ secrets.PUBLICFEEDURL }} --source ${{ secrets.PRIVATEFEED_URL }}

    - name: Build Code
      run: dotnet build Shared.sln --configuration Release

    - name: Run Unit Tests
      run: |
        echo "ASPNETCORE_ENVIRONMENT are > ${ASPNETCORE_ENVIRONMENT}"
        dotnet test "Shared.Tests\Shared.Tests.csproj" \
            /p:CollectCoverage=true \
            /p:Exclude="[xunit*]*" \
            /p:ExcludeByAttribute="Obsolete" \
            /p:ExcludeByAttribute="GeneratedCodeAttribute" \
            /p:ExcludeByAttribute="CompilerGeneratedAttribute" \
            /p:ExcludeByAttribute="ExcludeFromCodeCoverageAttribute" \
            /p:CoverletOutput="../lcov1.info" /maxcpucount:1 \
            /p:CoverletOutputFormat="lcov"

        dotnet test "Shared.EventStore.Tests\Shared.EventStore.Tests.csproj" \
            /p:CollectCoverage=true /p:Exclude="[xunit*]*" \
            /p:ExcludeByAttribute="Obsolete" \
            /p:ExcludeByAttribute="GeneratedCodeAttribute" \
            /p:ExcludeByAttribute="CompilerGeneratedAttribute" \
            /p:ExcludeByAttribute="ExcludeFromCodeCoverageAttribute" \
            /p:CoverletOutput="../lcov2.info" /maxcpucount:1 /p:CoverletOutputFormat="lcov"

    - name: Use public npm registry
      run: npm config set registry https://registry.npmjs.org/

    - name: Install LCOV merger
      run: npm install -g lcov-result-merger

    - name: Merge LCOV reports
      run: |
        mkdir -p coverage
        lcov-result-merger "*.info" > lcov.info

    - name: Upload merged coverage to Codacy
      uses: codacy/codacy-coverage-reporter-action@v1
      with:
        project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
        coverage-reports: ./lcov.info

  testreports:
    name: "Nightly Build - Test Reports"
    env:
        ASPNETCORE_ENVIRONMENT: "Production"
        PAGES_ROOT_DIR: "docs"
        REPORT_SUBPATH: "test-report"
        RESULTS_DIR: TestResults

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2.3.4

    - name: Restore Nuget Packages
      run: dotnet restore Shared.sln --source ${{ secrets.PUBLICFEEDURL }} --source ${{ secrets.PRIVATEFEED_URL }}

    - name: Build Code
      run: dotnet build Shared.sln --configuration Release
      
    - name: Run Unit Tests
      run: |
        dotnet test "Shared.Tests\Shared.Tests.csproj"  --configuration Release --verbosity normal --logger "trx;LogFileName=shared-test-results.trx"
        dotnet test "Shared.EventStore.Tests\Shared.EventStore.Tests.csproj" --configuration Release --verbosity normal --logger "trx;LogFileName=eventstore-test-results.trx"

    - name: Upload TRX artifacts (optional)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trx-results
        path: '**/TestResults/*.trx'
        if-no-files-found: warn
        retention-days: 14

    - name: Prepare Pages output folder
      shell: bash
      run: |
          set -euo pipefail
          rm -rf public
          mkdir -p public

          if [ -n "${PAGES_ROOT_DIR}" ] && [ -d "${PAGES_ROOT_DIR}" ]; then
            echo "Copying existing Pages content from '${PAGES_ROOT_DIR}' to 'public/'..."
            rsync -a "${PAGES_ROOT_DIR}/" "public/"
          fi

          mkdir -p "public/${REPORT_SUBPATH}"

    - name: Generate HTML landing page + per-TRX pages
      shell: pwsh
      run: |
          $ErrorActionPreference = "Stop"

          $resultsDir = "${{ env.RESULTS_DIR }}"
          $reportSubPath = "${{ env.REPORT_SUBPATH }}"
          $outRoot = "public/$reportSubPath"
          New-Item -ItemType Directory -Force -Path $outRoot | Out-Null

          # Find TRX anywhere in the repo (common layout: **/TestResults/**.trx)
          $trxFiles = Get-ChildItem -Path . -Recurse -Filter *.trx |
            Where-Object { $_.FullName -match [regex]::Escape([IO.Path]::DirectorySeparatorChar + "TestResults" + [IO.Path]::DirectorySeparatorChar) } |
            Sort-Object FullName

          if (-not $trxFiles) { throw "No .trx files found (searched under repo root)." }

          function HtmlEscape([string]$s) {
            if ($null -eq $s) { return "" }
            return ($s -replace "&","&amp;" -replace "<","&lt;" -replace ">","&gt;" -replace '"',"&quot;" -replace "'","&#39;")
          }

          $landingRows = @()

          foreach ($f in $trxFiles) {
            [xml]$xml = Get-Content -Raw -Path $f.FullName

            $counters = $xml.TestRun.ResultSummary.Counters
            $total   = [int]$counters.total
            $passed  = [int]$counters.passed
            $failed  = [int]$counters.failed
            $skipped = [int]$counters.notExecuted

            # Create a stable filename per TRX
            $safeName = ($f.FullName.ToLowerInvariant() -replace '[^a-z0-9]+','-').Trim('-')
            $pageFile = "$safeName.html"
            $pagePath = Join-Path $outRoot $pageFile

            # Collect failed test cases (basic)
            $failedResults = @()
            $unitTestResults = $xml.TestRun.Results.UnitTestResult
            foreach ($r in $unitTestResults) {
              if ($r.outcome -eq "Failed") {
                $testName = HtmlEscape($r.testName)
                $msg = ""
                $stack = ""

                # Try to resolve error info (structure can vary)
                try {
                  $msg = HtmlEscape($r.Output.ErrorInfo.Message.'#text')
                  if (-not $msg) { $msg = HtmlEscape($r.Output.ErrorInfo.Message) }
                } catch {}

                try {
                  $stack = HtmlEscape($r.Output.ErrorInfo.StackTrace.'#text')
                  if (-not $stack) { $stack = HtmlEscape($r.Output.ErrorInfo.StackTrace) }
                } catch {}

                $failedResults += "<li><strong>$testName</strong><pre>$msg`n$stack</pre></li>"
              }
            }

            $failedSection = if ($failed -gt 0) {
              "<h2>Failed tests</h2><ol>$($failedResults -join "`n")</ol>"
            } else {
              "<p><strong>No failures.</strong></p>"
            }

            $trxName = HtmlEscape($f.Name)
            $trxPath = HtmlEscape($f.FullName)

            $pageHtml = @"
          <!doctype html>
          <html>
          <head>
            <meta charset="utf-8"/>
            <title>${{ github.repository }} - $trxName</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 24px; }
              a { color: #0969da; text-decoration: none; }
              table { border-collapse: collapse; margin: 12px 0; }
              th, td { border: 1px solid #ddd; padding: 8px; }
              th { background: #f5f5f5; text-align: left; }
              pre { background: #f6f8fa; padding: 12px; overflow: auto; }
            </style>
          </head>
          <body>
            <p><a href="./index.html">‚Üê Back to landing page</a></p>
            <h1>${{ github.repository }} - Test Report</h1>
            <p><code>$trxPath</code></p>

            <table>
              <tr><th>Total</th><td>$total</td></tr>
              <tr><th>Passed</th><td>$passed</td></tr>
              <tr><th>Failed</th><td>$failed</td></tr>
              <tr><th>Skipped</th><td>$skipped</td></tr>
            </table>

            $failedSection
          </body>
          </html>
          "@

            Set-Content -Path $pagePath -Value $pageHtml -Encoding UTF8

            $landingRows += "<tr><td><a href=""./$pageFile"">$trxName</a></td><td>$total</td><td>$passed</td><td>$failed</td><td>$skipped</td></tr>"
          }

          $landingHtml = @"
          <!doctype html>
          <html>
          <head>
            <meta charset="utf-8"/>
            <title>${{ github.repository }} - Test Reports</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 24px; }
              table { border-collapse: collapse; width: 100%; }
              th, td { border: 1px solid #ddd; padding: 8px; }
              th { background: #f5f5f5; text-align: left; }
              a { color: #0969da; text-decoration: none; }
            </style>
          </head>
          <body>
            <h1>${{ github.repository }} - Test Reports</h1>
            <p>
              Generated from TRX on run <strong>${{ github.run_number }}</strong>.
              Repo: <code>${{ github.repository }}</code>
            </p>

            <table>
              <thead>
                <tr>
                  <th>TRX</th><th>Total</th><th>Passed</th><th>Failed</th><th>Skipped</th>
                </tr>
              </thead>
              <tbody>
                $($landingRows -join "`n")
              </tbody>
            </table>
          </body>
          </html>
          "@

          Set-Content -Path (Join-Path $outRoot "index.html") -Value $landingHtml -Encoding UTF8

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
          path: public

    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
